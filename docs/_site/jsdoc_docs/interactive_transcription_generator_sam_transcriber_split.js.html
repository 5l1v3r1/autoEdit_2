<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: interactive_transcription_generator/sam_transcriber/split.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: interactive_transcription_generator/sam_transcriber/split.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Takes in an audio file, and splits at 5 minutes intervalls.
 * NOTE: technically this does not guarantee that each file will be less then 100mb, altho seems to work with no problems is not 100% sure.
 * TODO: figure out how to make sure each file does not exceeen 100mb (othwerwise it be rejected by IBM Watson STT service )
 *
 * takes in file, tmp folder where to put audio files trimmed. and a callback tha returns array with name of files and offest from start, to be able to concact the transcription json from IBM Watson STT Service back togethere as one big file, with word timecodes relative to the original audio/video file times.
 [{
 name: filename,
 offset: 0
 }]
 *
 */
var ffmpeg = require('fluent-ffmpeg');

var path = require('path');
var fs = require('fs');
var trimmer = require('./trimmer.js');

// TODO: refactor this to use ffmpeg-fluent/ffpeg probe 
// https://github.com/fluent-ffmpeg/node-fluent-ffmpeg#reading-video-metadata
// var ffmpegBin = "/Users/pietropassarelli/Dropbox/CODE/Vox/TBVE_components/bin/ffmpeg";

//TODO: refactor using config, needs refactroing index.js of sam transcriber if you do
function split(file, tmpFolder, ffmpegBinPath, ffprobeBinPath, cb) {
  var maxLength = 60 * 5;
  var total = 0;
  var files = [];

  // set ffprobe bin

  if ( ffprobeBinPath ) {
    console.info(ffprobeBinPath);
    console.log(ffprobeBinPath);
    //setting ffmpeg bin
    ffmpeg.setFfprobePath(ffprobeBinPath);
  } else {
    console.warn("ffprobe binary path not defined, so using system one. if available");
  }

  var finishedSplit = function(filename, start) {
    // console.log(start)
    files.push({
      name: filename,
      offset: start
    });

    total--;

    if (parseInt(total) === 0) {
      console.log("end of split function");
      // console.log(files)
      cb(files);
    }//if
  };

  // ffprobe to get  duration
  ffmpeg.ffprobe(file, function(err, metadata) {
    var duration = metadata.streams[0].duration;

    total = parseInt(duration/maxLength)+1;
    if (duration > maxLength) {

      //trim
      for(var i =0; i&lt;duration; i+=maxLength){

        var fileName = path.parse(file).base;

        var filePart = tmpFolder+"/"+ fileName + '.' + i + '.wav';

        trimmer.trim({
          src: file,
          input: i,
          duration: maxLength,
          outputName: filePart,
          ffmpegBin: ffmpegBinPath,
          callback: finishedSplit
        });

      }//for
    } else {
      cb([{
        name: file,
        offset: 0
      }]);
    }
  });
}

module.exports = split;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#autoEdit2API">autoEdit2API</a></li><li><a href="global.html#convert">convert</a></li><li><a href="global.html#ffmpeg">ffmpeg</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getFileName">getFileName</a></li><li><a href="global.html#makePaperEdit">makePaperEdit</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#readVideoMetadataForEDL">readVideoMetadataForEDL</a></li><li><a href="global.html#send_to_gentle">send_to_gentle</a></li><li><a href="global.html#SendToWatson">SendToWatson</a></li><li><a href="global.html#watson">watson</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.1</a> on Thu Sep 29 2016 16:19:47 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
