<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: interactive_transcription_generator/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: interactive_transcription_generator/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* @module interactive_transcriptionn_generator
* @example
  var config = {
  videoUrl: "",
  title: "",
  description: "",
  tmpWorkFolder: "",
  destFolder:""
  }
  */
var fs = require("fs");
var path = require("path");

var generate = function(config) {
  //TODO: adda tmp word folder, and dest folder in var?
  var transcribe = require("./transcriber/index.js");
  var convert_video = require("./video_to_html5_webm/index.js");
  var MetadataReader = require("./video_metadata_reader/index.js");
  // console.log(process.cwd())

  //NOTE_if running index_example, need to change the path of bin
  var ffmpegPath =  process.cwd() + "/interactive_transcription_generator/bin/ffmpeg";
  // var ffmpegPath =  "./interactive_transcription_generator/bin/ffmpeg";
  //TODO: move to local bin
  var ffprobePath = process.cwd() + "/interactive_transcription_generator/bin/ffprobe";

  // var ffprobePath = "./interactive_transcription_generator/bin/ffprobe";

  var videoFile = config.videoUrl;
  //TODO: do .tmp/audio  folder for audio files in root of sails
  // var audioFileName = "./"+path.parse(videoFile).base+".wav";
  var videoFileName = path.parse(videoFile).base;
  videoFileName = videoFileName.replace(/\s+/g,"_");
  // var currentDir = process.cwd().split(path.sep)[process.cwd().split(path.sep).length -1];

  //Make audio and webm file unique. Eg so that if upload same video twice it gets different audio and video preview.
  //by using `timeNowFileName()`  in `frontEnd/date_now/index.js`
  // var audioFileName     = process.cwd() + config.destFolder + "/" + videoFileName +"."+Date.now()+ ".wav";
  // var oggOutputNamePath = process.cwd() + config.destFolder + "/" + videoFileName +"."+Date.now()+ ".webm";

  var audioFileName     = config.destFolder + "/" + videoFileName +"."+Date.now()+ ".wav";
  var oggOutputNamePath = config.destFolder + "/" + videoFileName +"."+Date.now()+ ".webm";

  // TODO: use system application data folder
  var appRootFolderForMedia = config.tmpWorkFolder;
  // ""+ process.cwd()+"/.tmp/"+path.parse(videoFile).base+".ogg"
  // var audioFileAbsolutePath = path.resolve(audioFileName)
  var audioFileAbsolutePath = audioFileName;

  // TODO: use system temp folder
  // var tmpFolderCwd = process.cwd() + "/tmp_media";
  // var tmpFolder = path.resolve(tmpFolderCwd);
  var tmpFolder = config.tmpWorkFolder;



  // var newTranscription= {
  //  title: config.title,
  //  description: config.description,
  //  videoUrl: config.videoUrl,
  //  // status: false,
  //  // text:
  //  //videoOgg:
  //  //metadata:
  // }


  //  // cb to save // return transcription to save 

  // /////////////////////////////////////////
  // console.log(config.keys)
  //spawn new process 

  //TODO: add language / model var, argument
  transcribe({
    videoFile: config.videoUrl,
    // keys: global.keys,
    keys: config.keys,
    audioFileOutput: audioFileAbsolutePath,
    ffmpegBin: ffmpegPath,
    ffprobePath: ffprobePath,
    tmpPath: tmpFolder,
    languageModel: config.languageModel,
    sttEngine: config.sttEngine,

    callback: function(respTranscriptJson){
      console.log("###############-ITG Done transcribing"+videoFile);
      console.log("config.videoUrl "+ config.videoUrl);
      // console.log(JSON.stringify(respTranscriptJson));

      var created = {};
      var paragraphs = [{"id":0,  "speaker": "Unamed Speaker ","paragraph":{}}];
      //update paragraphs of transcription
      paragraphs[0].paragraph = respTranscriptJson;

      created.status = true;
      created.text = paragraphs;

      var tmpAudioDirPath = path.parse(audioFileAbsolutePath).dir;
      var tmpAudioDir = appRootFolderForMedia;
      var tmpAudioName = path.parse(audioFileAbsolutePath).base;
      //".." because root is index which is inside `frontEnd` and 
      created.audioFile =  audioFileName;
      // created.audioFile =  ".."+config.destFolder+"/"+tmpAudioName;
      // console.log("created.audioFile")
      // console.log(created.audioFile)

      created.processedAudio= true;
      created.id = config.id;
      created.videoFile = videoFile;

      console.log("###############-ITG updates transcription"+videoFile);

      if(config.cbTranscription){
        console.info("inside interactive_transcription_generator index created.videoFile: "+ created.videoFile);
        // fs.writeFileSync("/"+created.videoFile+".json",JSON.stringify(created, null,"\t"));

        config.cbTranscription(created);
      }
      //Callback to save

    } //callback transcriber
  }); //transcriber

  /////////////////////////////////////////

  //spawn new process
  MetadataReader.read({
    file: videoFile,
    ffprobePath: ffprobePath,
    callback: function(resp){
      console.log("###############-ITG metadata "+videoFile);
      // console.log(JSON.stringify(resp));
      //add metadata to transcription
      // created.metadata = resp;

      //CALLBACL HERE 

      if(config.cbMetadata){
        config.cbMetadata(resp);
      }
      //callback to save

    }//end callback
  });//end read metadata


  /////////////////////////////////////////

  ////spawn new process 
  convert_video({
    src: videoFile,
    outputName: oggOutputNamePath,
    ffmpegBin: ffmpegPath,
    callback: function(outputName){
      console.log("#########-ITG Saving webm video file "+JSON.stringify(outputName));
      var tmpVideoDirPath = path.parse(outputName).dir;

      var created = {};

      var tmpVideoDir = appRootFolderForMedia;
      var tmpFileName = path.parse(outputName).base;

      // created.videoOgg =  tmpVideoDir+ "/"+tmpFileName;
      created.videoOgg = oggOutputNamePath;
      created.processedVideo= true;
      //CALLBACK HERE 

      if(config.cbVideo){
        config.cbVideo(created);
      }
    }
  });
};
//InteractiveTranscriptionGenerator({videoUrl: "",title: "",description: "", tmpWorkFolder: "",destFolder:"" })

module.exports = generate;

// example use
// var iTg = new InteractiveTranscriptionGenerator();
// iTg.generate({
//  /// config with callbacks
// })
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-autoEdit2API.html">autoEdit2API</a></li><li><a href="module-convert_to_wav.html">convert_to_wav</a></li><li><a href="module-edl_composer.html">edl_composer</a></li><li><a href="module-interactive_transcriptionn_generator.html">interactive_transcriptionn_generator</a></li><li><a href="module-parse.html">parse</a></li><li><a href="module-parseSamJsonToTranscripJson.html">parseSamJsonToTranscripJson</a></li><li><a href="module-send_to_gentle.html">send_to_gentle</a></li><li><a href="module-SendToWatson.html">SendToWatson</a></li><li><a href="module-split.html">split</a></li><li><a href="module-srt.html">srt</a></li><li><a href="module-transcriber.html">transcriber</a></li><li><a href="module-trimmer.html">trimmer</a></li><li><a href="module-video_metadata_reader.html">video_metadata_reader</a></li><li><a href="module-video_to_html5_webm.html">video_to_html5_webm</a></li><li><a href="module-writeOut.html">writeOut</a></li></ul><h3>Classes</h3><ul><li><a href="autoEdit2API.html">autoEdit2API</a></li><li><a href="module-edl_composer-EDL.html">EDL</a></li><li><a href="SendToWatson.html">SendToWatson</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-EDL_format.html">EDL_format</a></li><li><a href="tutorial-IBM_watson_stt_specs.html">IBM_watson_stt_specs</a></li><li><a href="tutorial-autoEdit2_transcrition_json_spec.html">autoEdit2_transcrition_json_spec</a></li><li><a href="tutorial-components.html">components</a></li><li><a href="tutorial-configuration.html">configuration</a></li><li><a href="tutorial-dependencies.html">dependencies</a></li><li><a href="tutorial-deployment.html">deployment</a></li><li><a href="tutorial-gentle_transcription_json_spec.html">gentle_transcription_json_spec</a></li><li><a href="tutorial-github.html">github</a></li><li><a href="tutorial-intro.html">intro</a></li><li><a href="tutorial-licence.html">licence</a></li><li><a href="tutorial-prerequisites.html">prerequisites</a></li><li><a href="tutorial-tests.html">tests</a></li><li><a href="tutorial-updating_the_documentation.html">updating_the_documentation</a></li></ul><h3>Global</h3><ul><li><a href="global.html#makePaperEdit">makePaperEdit</a></li><li><a href="global.html#nw">nw</a></li><li><a href="global.html#transcribe">transcribe</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Wed Oct 19 2016 00:23:53 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
