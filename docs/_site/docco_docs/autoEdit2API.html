<!DOCTYPE html>

<html>
<head>
  <title>autoEdit2API.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="config.html">
                  config.js
                </a>
              
                
                <a class="source" href="deploy.html">
                  deploy.js
                </a>
              
                
                <a class="source" href="autoEdit2API.html">
                  autoEdit2API.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="demo_jr.html">
                  demo_jr.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="transcriptions.html">
                  transcriptions.js
                </a>
              
                
                <a class="source" href="transcription.html">
                  transcription.js
                </a>
              
                
                <a class="source" href="router.html">
                  router.js
                </a>
              
                
                <a class="source" href="sync.html">
                  sync.js
                </a>
              
                
                <a class="source" href="transcription_form.html">
                  transcription_form.js
                </a>
              
                
                <a class="source" href="transcription_index.html">
                  transcription_index.js
                </a>
              
                
                <a class="source" href="transcription_show.html">
                  transcription_show.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="convert_to_audio.html">
                  convert_to_audio.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="split.html">
                  split.js
                </a>
              
                
                <a class="source" href="trimmer.html">
                  trimmer.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>autoEdit2API.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
* @module autoEdit2API
* @description Manages the backend of the app by overwrighting backbone.sync function
* @author Pietro Passarelli 
* @requires fs
* @requires path
* @requires linvodb
* @requires level-js
* @requires interactive_transcription_generator/index.js
* @todo Write documentation.
* @todo add error handling and error callbacks
*/</span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">var</span> transcription_generate = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../interactive_transcription_generator/index.js"</span>);
<span class="hljs-keyword">var</span> LinvoDB = <span class="hljs-built_in">require</span>(<span class="hljs-string">"linvodb3"</span>);

LinvoDB.defaults.store = { <span class="hljs-attr">db</span>:  <span class="hljs-built_in">require</span>(<span class="hljs-string">"medeadown"</span>) }; <span class="hljs-comment">//medea level-js</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO:change db with medea
+db path, for now in root of app, to be change so that in config where user can set where they want it, but also provide a default. 
LinvoDB.dbPath = path.join(process.cwd(), “/db”); </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>LinvoDB.dbPath = <span class="hljs-built_in">window</span>.config.dataPath;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>setting up transcription model in database.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> transcriptionModel = <span class="hljs-string">"transcription"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Non-strict always, can be left empty</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> schema = { }; 
<span class="hljs-keyword">var</span> options = { };
<span class="hljs-keyword">var</span> Transcription = <span class="hljs-keyword">new</span> LinvoDB(transcriptionModel, schema, options);

<span class="hljs-comment">/**
* @constructs autoEdit2API
* @description API Object to override Backnone.sync
* @param {object} method - Backbone RESTfull method request.
* @param {object} model - Backbone model being handled.
* @param {object} options - Sucess or failure callback.
*/</span>
<span class="hljs-keyword">var</span> autoEdit2API = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method, model, options</span>)</span>{
  autoEdit2API[method](model, options.success, options.error);
};

<span class="hljs-comment">/**
* @function 
* @description Create functionality, mapped to REST POST
* @param {object} method - Backbone RESTfull method request.
* @param {object} model - Backbone model being handled.
* @param {object} options - Sucess or failure callback.
* @returns {object} sucess callback with backbone model containing db id
*/</span>
autoEdit2API.create = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model, success, error</span>)</span>{
  <span class="hljs-keyword">if</span>( model.constructor.modelType == <span class="hljs-string">"transcription"</span>){
    
    <span class="hljs-keyword">var</span> newElement = model.toJSON();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>create transcription element to save in db </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> transcription = <span class="hljs-keyword">new</span> Transcription(newElement);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>save transcription in db</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transcription.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>updating backbone with saved transcritpion, containing db id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      model.set(transcription);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>returning saved transcription callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      success(model);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>setting up media folders for media and tmp media on local file system, user libary application support folder </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> tmpMediaFolder = <span class="hljs-built_in">window</span>.config.dataPath+<span class="hljs-string">"/tmp_media"</span>;
    <span class="hljs-keyword">var</span> mediaFolder = <span class="hljs-built_in">window</span>.config.dataPath+<span class="hljs-string">"/media"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>if media folder does not exists create it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!fs.existsSync(tmpMediaFolder)){
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"tmpMediaFolder folder not present, creating tmpMediaFolder folder"</span>);
        fs.mkdirSync(tmpMediaFolder);
    }<span class="hljs-keyword">else</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>do nothing, build folder was already there</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"tmpMediaFolder folder was already present"</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>if temp media folder does not exists create it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!fs.existsSync(mediaFolder)){
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"mediaFolder folder not present, creating mediaFolder folder"</span>);
        fs.mkdirSync(mediaFolder);
    }<span class="hljs-keyword">else</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>do nothing, build folder was already there</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"mediaFolder folder was already present"</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>using interactive_transcription_generator to generate metadata, 
transcription json 
webm video preview </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transcription_generate({
      <span class="hljs-attr">id</span>: transcription._id,
      <span class="hljs-attr">videoUrl</span>: newElement.videoUrl,
      <span class="hljs-attr">title</span>: newElement.title,
      <span class="hljs-attr">description</span>: newElement.description,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO: this is hardcoded, and this variable is not used, fix me!
tmpWorkFolder:”/“,
destFolder:”/media”,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      tmpWorkFolder: tmpMediaFolder,
      <span class="hljs-attr">destFolder</span>: mediaFolder,
      <span class="hljs-attr">keys</span>: global.keys,
      <span class="hljs-attr">languageModel</span>: newElement.languageModel,
      <span class="hljs-attr">sttEngine</span>: newElement.sttEngine,
      <span class="hljs-attr">cbMetadata</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">respM</span>)</span>{
        meta = respM;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>update current transcription with metadata data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Transcription.findOne({ <span class="hljs-attr">_id</span>: transcription._id }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, trs</span>) </span>{
          <span class="hljs-built_in">console</span>.info(<span class="hljs-string">"got metadata for transcription: "</span>+transcription._id)
          trs.metadata = respM;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>saving current transcription</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          trs.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>app.trigger(‘updateTranscription:’+trs._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          });
        });
      },
      <span class="hljs-attr">cbTranscription</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resp</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>updating current transcription with transcription json.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Transcription.findOne({ <span class="hljs-attr">_id</span>: resp.id }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, trs</span>) </span>{
          <span class="hljs-built_in">console</span>.info(<span class="hljs-string">"got transcription json for transcription: "</span>+ trs._id);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>updating transcription attributes with result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          trs.audioFile = resp.audioFile;
          trs.processedAudio = resp.processedAudio;
          trs.text = resp.text;
          trs.status = resp.status;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>saving current transcription </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          trs.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>app.trigger(‘updateTranscription:’+trs._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          });
        });
      },
      <span class="hljs-attr">cbVideo</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resp</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>updating current transcription with webm html5 video preview.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Transcription.findOne({ <span class="hljs-attr">_id</span>: transcription._id}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, trs</span>) </span>{
          <span class="hljs-built_in">console</span>.info(<span class="hljs-string">"got video webm back for transcription: "</span>+ trs._id);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>updating transcription attributes with result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          trs.videoOgg = resp.videoOgg;
          trs.processedVideo = resp.processedVideo;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>saving current transcription </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          trs.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>app.trigger(‘updateTranscription:’+trs._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          });
        });
      }
    });
  }
}

<span class="hljs-comment">/**
* @function 
* @description Read functionality,Find all  and fine One, mapped to REST GET
* @param {object} method - Backbone RESTfull method request.
* @param {object} model - Backbone model being handled.
* @param {object} options - Sucess or failure callback.
* @returns {object} sucess callback with backbone model
*/</span>
autoEdit2API.read = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model, success, error</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>If a colleciton</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (model.models) {
    <span class="hljs-built_in">console</span>.info(<span class="hljs-string">"Collection:"</span> +model.constructor.modelType )</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>for transcription model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( model.constructor.modelType == <span class="hljs-string">"transcriptions"</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>look in database</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Transcription.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, transcriptions</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>return transcription collection </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        success(transcriptions);
      });
    }<span class="hljs-comment">//if transcription collection</span>
  }<span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>if a model </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">console</span>.info(<span class="hljs-string">"Model: "</span>+model.constructor.modelType)</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>for transcription model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(model.constructor.modelType == <span class="hljs-string">"transcription"</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>looks in database using transcription id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Transcription.findOne({ <span class="hljs-attr">_id</span>: model._id }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, transcription</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>return transcription model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          success(transcription)
      });
    }
  }
}

<span class="hljs-comment">/**
* @function 
* @description Update functionality, mapped to REST PUT
* @param {object} method - Backbone RESTfull method request.
* @param {object} model - Backbone model being handled.
* @param {object} options - Sucess or failure callback.
* @returns {object} sucess callback with backbone model
*/</span>
autoEdit2API.update = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model, success, error</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>for transcription model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(model.constructor.modelType == <span class="hljs-string">"transcription"</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>looks in database using transcription id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Transcription.findOne({ <span class="hljs-attr">_id</span>: model.get(<span class="hljs-string">"_id"</span>) }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, doc</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TODO: there’s got to be a better way to do this
NOTE: rather then using update, which did not seemed to be optimised for speed.
uses <code>findOne</code>, replaces attributes with new once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      doc.text                = model.attributes.text;
      doc.languageModel       = model.attributes.languageModel;
      doc.counterForPaperCuts = model.attributes.counterForPaperCuts;
      doc.processedAudio      = model.attributes.processedAudio;
      doc.processedVideo      = model.attributes.processedVideo;
      doc.status              = model.attributes.status;
      doc.highlights          = model.attributes.highlights;
      doc.title               = model.attributes.title;
      doc.videoUrl            = model.attributes.videoUrl;
      doc.sttEngine           = model.attributes.sttEngine;
      doc.audioFile           = model.attributes.audioFile;
      doc.metadata            = model.attributes.metadata;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>saving transcription to database</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      doc.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>returning sucess callback with backbone model to client side</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        success(model);
      });
    });
  } 
}

<span class="hljs-comment">/**
* @function 
* @description Patch functionality, mapped to REST PUT
* @param {object} method - Backbone RESTfull method request.
* @param {object} model - Backbone model being handled.
* @param {object} options - Sucess or failure callback.
* @returns {object} sucess callback with backbone model
*/</span>
autoEdit2API.patch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model, success, error</span>)</span>{
  <span class="hljs-keyword">if</span>(model.constructor.modelType == <span class="hljs-string">"transcription"</span>){
     Transcription.findOne({ <span class="hljs-attr">_id</span>: model.get(<span class="hljs-string">"_id"</span>) }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, doc</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>TODO: there’s got to be a better way to do this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      doc.text                = model.attributes.text;
      doc.languageModel       = model.attributes.languageModel;
      doc.counterForPaperCuts = model.attributes.counterForPaperCuts;
      doc.processedAudio      = model.attributes.processedAudio;
      doc.processedVideo      = model.attributes.processedVideo;
      doc.status              = model.attributes.status;
      doc.highlights          = model.attributes.highlights;
      doc.title               = model.attributes.title;
      doc.videoUrl            = model.attributes.videoUrl;
      doc.sttEngine           = model.attributes.sttEngine;
      doc.audioFile           = model.attributes.audioFile;
      doc.metadata            = model.attributes.metadata;

      doc.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        success(model);
      });
    });
  }
}

<span class="hljs-comment">/**
* @function 
* @description Delete functionality, mapped to REST Delete
* @param {object} method - Backbone RESTfull method request.
* @param {object} model - Backbone model being handled.
* @param {object} options - Sucess or failure callback.
* @returns {object} sucess callback with backbone model
*/</span>
autoEdit2API.delete = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model, success, error</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>/for transcription model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(model.constructor.modelType == <span class="hljs-string">"transcription"</span>){
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"autoEdit2API"</span>)
    <span class="hljs-built_in">console</span>.log(model.attributes.title)
    <span class="hljs-built_in">console</span>.log(model.attributes._id)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>looks in database using transcription id
worth looking into alternative
<a href="https://github.com/Ivshti/linvodb3#removing-from-the-collection">https://github.com/Ivshti/linvodb3#removing-from-the-collection</a> </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Transcription.remove({ <span class="hljs-attr">_id</span>: model._id }, {<span class="hljs-attr">multi</span>: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, numRemoved</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>removing media associated with transcription.
TODO: this only deletes the video if the video has done processing. think about refactoring so that attribute can be present before processing starts. As it is now this means incomplete vidoes are left in the folder if the transcription is deleted</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(model.attributes.processedVideo){</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>TODO: review if this is the right way to check if the file exists before deleting it. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>(fileExists( model.attributes.videoOgg)){
            fs.unlinkSync( model.attributes.videoOgg);  
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>if the trascription has been shown the audio will always be present because is needed to generate the text transcription. But having test here just in case</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(model.attributes.audioFile){
          <span class="hljs-keyword">if</span>(fileExists( model.attributes.audioFile)){
            fs.unlinkSync( model.attributes.audioFile);
          } 
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>returns sucess callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">console</span>.log(model.attributes._id)
        success(model);</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>}); </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    });
  }
}

<span class="hljs-comment">/**
* @function fileExists
* @description helper function to check if a file exists
* @param {string} filename - the file path to check.
* returns {boolean} - True if it exists, False if it doesn't
*/</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fileExists</span>(<span class="hljs-params">filename</span>)</span>{
<span class="hljs-keyword">try</span>{
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).accessSync(filename)
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}<span class="hljs-keyword">catch</span>(e){
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
}

<span class="hljs-built_in">module</span>.exports = autoEdit2API;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
