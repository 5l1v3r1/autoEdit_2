<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: interactive_transcription_generator/sam_transcriber/split.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: interactive_transcription_generator/sam_transcriber/split.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Takes in an audio file, if it exceeds 5 minutes, it splits at 5 minutes intervalls. 
 * Used by sam_transcriber/index.js module.
 * @todo: technically this does not guarantee that each file will be less then 100mb, altho seems to work with no problems is not 100% sure. 
 * @todo: figure out how to make sure each file does not exceeen 100mb (othwerwise it be rejected by IBM Watson STT service )
 *
 * takes in file, tmp folder where to put audio files trimmed. and a callback tha returns array with name of files and offest from start, to be able to concact the transcription json from IBM Watson STT Service back togethere as one big file, with word timecodes relative to the original audio/video file times.
   [
    {
      name: filename,
      offset: 0
     },
     ...
   ]
 *
 * @requires fluent-ffmpeg
 * @requires path
 * @requires fs
 * @requires trimmer.js uses costum trimer module to actually cut the clips.
 */

var ffmpeg  = require('fluent-ffmpeg');
var path    =  require('path');
var fs      = require('fs');
var trimmer = require('./trimmer.js');

/**
* @function splits an audio file, if it exceeds 5 minutes, in 5 minutes intervalls.  
* using ffprobe to read duration. ffmpeg passed to trimmer module.
* saves trimmed clips in temp folder   
* 
* @todo refactor using config, needs refactroing index.js of sam transcriber if you do
* @param {string} file -  audio file path
* @param {string} tmpFolder - path to a temporary folder to put temporary audio files created when dividing audio file into chunks to send to STT API.
* @param {string} ffmpegBinPath - path to ffmpeg binary. to pass to trimmer module
* @param {string} ffprobeBinPath - path to ffprobe binary. If not present it will try to use system one.
* @param {callback} callback - 
* @returns {callback} callback - returns array of audio clips names with offsts eg [{ name: filename, offset: 0 }]
*/
function split(file, tmpFolder, ffmpegBinPath, ffprobeBinPath, cb) {
  //maximum legth of clips in seconds. 5 minutes each.
  var maxLength = 60 * 5;
  //number of files
  var total = 0;
  //list of files
  var files = [];

  // set ffprobe bin
  if(ffprobeBinPath) {
    ffmpeg.setFfprobePath(ffprobeBinPath);
  } else {
    console.warn("ffprobe binary path not defined, so using system one. if available");
  }

  /**
  * @function adds info on trimmed clips to list of files. 
  * @param {string} - name of the audio clip 
  * @param {number} - clip time offset in seconds, in 5 min intervals
  * @returns {callback} callback - return list of files
  */
  var finishedSplit = function(filename, start) {
    files.push({
      name: filename,
      offset: start
    });
    total--;
    if (parseInt(total) === 0) {
      console.log("end of split function");
      cb(files);
    }
  };

  // ffprobe to get duration
  ffmpeg.ffprobe(file, function(err, metadata) {
    //reads duration of file from metadata
    var duration = metadata.streams[0].duration;
    //divides total audio duration by the maximum length of the trimmed clips to work out in how many instance it needs to be divided
    total = parseInt(duration/maxLength)+1;
    // if click it's longer then 5 minutes
    if (duration > maxLength) {
      //trim audio file into clips 
      for(var i =0; i&lt;duration; i+=maxLength){
        //file name of original audio file
        var fileName = path.parse(file).base;
        //file name for clips 
        var filePart = tmpFolder+"/"+ fileName + '.' + i + '.wav';
        //trim audio files 
        trimmer.trim({
          src: file,
          input: i,
          duration: maxLength,
          outputName: filePart,
          ffmpegBin: ffmpegBinPath,
          //when done trimming add clip to the list through callback. finishedSplit takes in filename and start
          callback: finishedSplit
        });

      }
    } else {
      //if the audio file is less then 5 minutes then it returns a list with one element. to keep the interface.
      cb([{
        name: file,
        offset: 0
      }]);
    }
  });
}

module.exports = split;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="EDL.html">EDL</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addsinfoontrimmedclipstolistoffiles.">adds info on trimmed clips to list of files.</a></li><li><a href="global.html#autoEdit2API">autoEdit2API</a></li><li><a href="global.html#convertTakesinaconfigobjectwithpropreties:src,outputName,ffmpegBinandoptionalcallback.">convert
Takes in a config object with propreties: src, outputName, ffmpegBin and optional callback.</a></li><li><a href="global.html#convertToWav">convertToWav</a></li><li><a href="global.html#createSrtContent">createSrtContent</a></li><li><a href="global.html#fromSeconds">fromSeconds</a></li><li><a href="global.html#fromSecondsForSrt">fromSecondsForSrt</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getFileName">getFileName</a></li><li><a href="global.html#makePaperEdit">makePaperEdit</a></li><li><a href="global.html#nw">nw</a></li><li><a href="global.html#padNumber">padNumber</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#send_to_gentle">send_to_gentle</a></li><li><a href="global.html#SendToWatson">SendToWatson</a></li><li><a href="global.html#splitsanaudiofile,ifitexceeds5minutes,in5minutesintervalls.usingffprobetoreadduration.ffmpegpassedtotrimmermodule.savestrimmedclipsintempfolder">splits an audio file, if it exceeds 5 minutes, in 5 minutes intervalls.  
using ffprobe to read duration. ffmpeg passed to trimmer module.
saves trimmed clips in temp folder</a></li><li><a href="global.html#toSeconds">toSeconds</a></li><li><a href="global.html#transcribeTakesinthefilepathtoamediaaudioorvideofileandreturnsajsonoftranscription.convertsaudioormediafileintoaudiomeetingIBMSpecsdividesaudiotosendtoSTTAPIinto5minchunkssendsallclipsallatoncereconnectsresultsasreturnedbySTTAPIintoonejsonfilethatmeetstheautoEdit2specsreturnsthatascallback">transcribe
Takes in the file path to a media audio or video file and returns a json of transcription.
converts audio or media file into audio meeting IBM Specs
divides audio to send to STT API into 5 min chunks
sends all clips all at once 
reconnects results as returned by STT API into one json file that meets the autoEdit2 specs
returns that as callback</a></li><li><a href="global.html#trim">trim</a></li><li><a href="global.html#watson">watson</a></li><li><a href="global.html#%257Bstirng%257DEDL-andEDLstringforanEDLline.">{stirng} EDL - and EDL string  for an EDL line.</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Tue Oct 18 2016 10:41:31 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
